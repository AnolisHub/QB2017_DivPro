---
title: Effects of Soil Warming Plus Nitrogen Addition on Plant Richness and Diversity
  at Harvard Forest
author: "Roy Moger-Reischer and Katie Beidler"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: pdf_document
geometry: margin=2.54cm
---

## PROJECT OVERVIEW

The overall objective of this project is to investigate whether soil warming and N fertilization alter plant biodiversity through time (2006-2009). The data for this project came from the Harvard Forest LTER site. [link](https://portal.lternet.edu/nis/metadataviewer?packageid=knb-lter-hfr.45.24)

**Research Question**: What are the short-term effects of soil warming plus N additions on plant richness and diversity at Harvard Forest from 2006-2009?

> ***Hypothesis 1***: Richness and diversity will decrease over time in warming treatments

> ***Hypothesis 2***: Richness and diversity will increase over time with the addition of nitrogen

## BACKGROUND
    Two of the most well-documented outcomes of anthropogenic global change are nitrogen deposition and climatic warming. In 2006 a group at the Harvard Forest LTER initiated an experiment to assess the in-teractive effects of these two environmental changes on plant, arthro-pod, and soil microbe community composition, and soil respiration. Six replicate plots for each of four treatments (Control; N deposition; heated; N & heated interaction) were established. N deposition plots received 50 kg N/ha/yr. Heated plots were warmed to 5 °C above ambient temperature.
    In this analysis we evaluated primarily plant community and soil abiotic properties. Abundances of 40 plant species were censused each year 2006 - 2009. Soil abiotic variables were measured ~monthly during this time. We used R to explore the effects of treatment and time plant biodiversity and soil carbon and nitrogen dynamics.

## 1) SETUP
### A. Retrieve and Set your Working Directory
```{r setup, include=FALSE}
clr = function() {
  ENV = globalenv()
  ll = ls(envir = ENV)
  ll = ll[ll != "clr"]
  rm(list = ll, envir = ENV)
}
getwd() 
setwd("/Users/bhbeidler/GitHub/QB2017_DivPro/Data")
```
### B.Install Packages
This analysis will require several packages. The require() function in R returns TRUE if the package was successfully loaded or FALSE if the package failed to load. This for loop loads each package and installs the package when require() returns FALSE.
```{r results='hide', message=FALSE, warning=FALSE} 
package.list = c('vegan', 'tidyr', 'dplyr', 'codyn', 'ggplot2','betapart','splitstackshape',
'cowplot', 'MullerPlot', 'RColorBrewer','lubridate', 'reshape2', 'lubridate','wesanderson',
'TTR', 'xtable', 'multcomp', 'pander', 'png', 'grid', 'tseries', 'nlme', 'forecast', 'lsmeans', 'devtools')

for (package in package.list) {
if (!require(package, character.only = TRUE, quietly = TRUE)) {
install.packages(package, repos='http://cran.us.r-project.org')
library(package, character.only = TRUE) }
}
```
## 2) LOADING DATA

### A. Description of Data Set
[Explain what is contained in the different data sheets...]
1. 'plant'
2. 'nmin'
3. 'resp'

```{r}
setwd("/Users/bhbeidler/GitHub/QB2017_DivPro/Data")
plant = read.csv("./HF_plants_treat.csv")
nmin = read.csv("./HF_nmin.csv", stringsAsFactors = FALSE)
resp = read.csv("./HF_soilresp.csv", stringsAsFactors = FALSE)
```
### B. Data Wrangling
Subsetting the data by year and producing site by species matrices. 
```{r}
# Making the Site by Species Matrix for the plant data set
plant_sbys = plant[ ,6:43]

# Subsetting the data into the different years
plant_06 = (filter(plant, year == 2006))
plant_07 = (filter(plant, year == 2007))
plant_08 = (filter(plant, year == 2008))
plant_09 = (filter(plant, year == 2009))

# Separating out the treatments from the site by species matrices 
plant_06_sbys = plant_06[ ,6:43]
plant_07_sbys = plant_07[ ,6:43]
plant_08_sbys = plant_08[ ,6:43]
plant_09_sbys = plant_09[ ,6:43]
```
## 3)  DATA VISUALIZATION & EDA
[plots that show richness for each site/ abundance for a particular species]
Visualizing Beta Diversity
```{r}
# Visualizing the Plant data set
str(plant, max.level = 1)

# Calculate observed richness from time-by-species matrix
p_richness = as.data.frame(rowSums(plant[,-c(1:5)] > 0)) 
# Create data frame with experimental design and richness data
p_rich.all = data.frame(plant[,1:5,], p_richness)
# Rename column
names(p_rich.all)[6] = "richness"

# avg. richness per group
# stand. dev. per group
# num. obs. per group
# calc. std. err. mean.
p_rich.treat.plot = group_by(p_rich.all, treatment, year) %>%
  summarise(mean = mean(richness), sd = sd(richness),n = n(),sem = sd/sqrt(n))

p_rich.plot = ggplot(p_rich.treat.plot, aes(x = year, y = mean, color = as.factor(treatment))) + 
               geom_point(size = 2, show.legend = T) +
               geom_line(size = 0.75) +
               geom_errorbar(aes(ymin = mean - sem, ymax = mean + sem), width = .1) +
               scale_color_manual(values = wes_palette("Moonrise1", 4, type = "discrete"),name="Soil Treatment",labels=c("Control", "Heated", "Heated plus Nitrogen", "Nitrogen")) +
               xlim(2006, 2009) + xlab("Year") + ylab("Richness") +
               theme_classic(base_size=15)+
               theme(axis.line.x = element_line(color = "black"), axis.line.y = element_line(color ="black"))
plot(p_rich.plot)


# Calculate diveristy from time-by-species matrix
p_diversity = diversity(plant[,-c(1:5)], "shannon")

# Create data frame with experimental design and diversity data
p_div.all = data.frame(plant[,1:5,], p_diversity)
# Rename column
names(p_div.all)[6] = "diversity"

p_div.treat.plot = group_by(p_div.all, treatment, year) %>%
  summarise(mean = mean(diversity), sd = sd(diversity),n = n(),sem = sd/sqrt(n))

p_div.plot = ggplot(p_div.treat.plot, aes(x = year, y = mean, color = as.factor(treatment))) + 
               geom_point(size = 2, show.legend = T) +
               geom_line(size = 0.75) +
               geom_errorbar(aes(ymin = mean - sem, ymax = mean + sem), width = .1) +
               scale_color_manual(values = wes_palette("Moonrise1", 4, type = "discrete"),name="Soil Treatment",labels=c("Control", "Heated", "Heated plus Nitrogen", "Nitrogen")) +
               xlim(2006, 2009) + xlab("Year") + ylab("Shannon's Diversity Index")+
               theme_classic(base_size=15)+
               theme(axis.line.x = element_line(color = "black"),axis.line.y = element_line(color = "black"))
plot(p_div.plot)
```
## 4) HYPOTHESIS TESTING
```{r}
p_rich.rm = lme(richness ~ year + heat_treat + N_treat * heat_treat * N_treat * year, random = ~ 1 | plot, correlation = corAR1(form = ~ 1 | plot),data = p_rich.all) 
summary(p_rich.rm) # Obtain F-test
anova(p_rich.rm)
# Make cleaner ANOVA table
set.caption("RMANOVA for Plant Richness Data") 
pander(anova(p_rich.rm))
 
# Perform an RM-ANOVA and construct a F-test using the AR(1)
p_div.rm = lme(diversity ~ year + heat_treat + N_treat * heat_treat * N_treat * year, random = ~ 1 | plot, correlation = corAR1(form = ~ 1 | plot),data = p_div.all) # Look at detailed output
summary(p_div.rm) # Obtain F-test
anova(p_div.rm)
set.caption("RMANOVA for Plant Diversity Data") 
pander(anova(p_div.rm))
```
## 4) TEMPORAL BIODIVERSITY
### A. Turnover
```{r}
# Making the wide site by species format into a long format- to get abundances for each species 
plant$row_id = 1:nrow(plant)
p.id = dplyr::select(plant, row_id, year, treatment)
plant.m = as.matrix(plant_sbys)
m1 = setNames(melt(plant.m), c('row_id','species','count'))
m2 = dplyr::filter(m1, count > 0)
m3 = expandRows(m2, "count")
plant_long = left_join(p.id,m3, by = "row_id")
p_long = dplyr::select(plant_long, -row_id)

# Calculate species abundances for each taxonomic group 
plant.sp.abunds = p_long %>% 
                     group_by(year,treatment) %>% 
                     count(species)

# Calculate total turnover
plant.total = turnover(df = plant.sp.abunds, time.var = "year",
                            species.var = "species",
                            abundance.var = "n",
                            replicate.var = "treatment",
                            metric = "total")
# Calculate species gained
plant.appearance = turnover(df = plant.taxa.abunds, time.var = "year",
                            species.var = "species",
                            abundance.var = "n",
                            replicate.var = "treatment",
                            metric = "appearance")
# Calculate species lost
plant.disappearance = turnover(df = plant.taxa.abunds, time.var = "year",
                            species.var = "species",
                            abundance.var = "n",
                            replicate.var = "treatment",
                            metric = "disappearance")

plant.turnover = full_join(plant.total, plant.disappearance) %>% 
                  full_join(plant.appearance)

plant.turnover = gather(plant.turnover, key = metric, value = turnover, total, appearance, disappearance)
View(plant.turnover)
# 3. Visualize turnover within each group

plant.turn.plot = ggplot(plant.turnover, aes(x = year, y = turnover, color = metric)) +
  geom_line(size = 1, show.legend = T) + facet_wrap(~treatment, ncol = 1) +
  xlim(2007, 2009) +
  xlab("Year") +
  ylab("Turnover") +
  theme(legend.position = "bottom") +
  scale_color_grey()
plot(plant.turn.plot)

# Low turnover is indicative of a stable community and high turnover is indicative of a dynamic community
```
### B. Rank Shift
```{r}

# Calculate species abundances for each taxonomic group 
plant.sp.abunds = p_long %>% 
                     group_by(year,treatment) %>% 
                     count(species)

# Calculate MRS
plant.rankshift = rank_shift(df = as.data.frame(plant.sp.abunds), 
                              time.var = "year",
                              species.var = "species",
                              abundance.var = "n",
                              replicate.var = "treatment")

plant.rankshift$year = as.numeric(substr(plant.rankshift$year_pair, 6, 9))

# Create ggplot
rankshift.plot =  ggplot(plant.rankshift, aes(x = year, y = MRS, color = treatment)) + geom_line(size = 1) +
xlim(2007, 2009) +
xlab("Year") +
ylab("Mean Rank Shift") + scale_color_grey()
plot(rankshift.plot)
portal.rankshift %>% 
  group_by (plot_type) %>% 
  summarise(mean = mean(MRS), cv = sd(MRS)/mean)
```
## 4) TIME SERIES FOR SOIL MEASURMENTS 
```{r}
resp = resp %>%
    filter(year %in% c("2006", "2007", "2008", "2009"))
resp$date = as.Date(resp$date, format = "%m/%d/%Y")
resp$doy = yday(resp$date)

resp_yr.plot = qplot(doy, co2flux, data = resp, geom="smooth") +
         stat_smooth(fill="azure3", colour="mediumpurple4", size=1, alpha = 0.2) + 
         theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
            panel.background = element_blank(), axis.line =   element_line(colour = "black")) + 
        facet_wrap(~year, ncol = 1)
        xlab("Day of the Year") +
        ylab("CO2 Flux") 
resp_yr.plot + theme(text = element_text(size=18), plot.title = element_text(lineheight=.8, face="bold")) + ggtitle("Soil Respiration 2006-2009")
plot(resp_yr.plot)


resp_trt.plot = qplot(doy, co2flux, data = resp, colour = as.factor(trt), geom="smooth", se=FALSE) +
      stat_smooth(method ="auto",se = FALSE, formula = y ~ x, size = 1) +
      facet_wrap(~year, ncol = 1) +
      theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
            panel.background = element_blank(), axis.line = element_line(colour = "black")) 
resp_trt.plot + scale_colour_brewer(type="seq", palette=3) + xlab("Day of the Year") +ylab("CO2 Flux)") + theme(text = element_text(size=18))
plot(resp_trt.plot)
```


